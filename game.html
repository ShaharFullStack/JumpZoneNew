<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משחק קצב מחיאות כפיים</title>
    
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-bg: #f0f4f8;
            --secondary-bg: #ffffff;
            --text-color: #333;
            --accent-color: #2a7a96;
            --success-color: #4caf50;
            --error-color: #f44336;
            --neutral-color: #ffc107;
        }

        body {
            font-family: 'Assistant', sans-serif;
            text-align: center;
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .game-container {
            width: 100%;
            max-width: 900px;
            background: var(--secondary-bg);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px 30px;
            box-sizing: border-box;
        }

        header h1 {
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .instructions {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 20px;
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            padding: 10px;
            background: #e9eef2;
            border-radius: 8px;
        }

        #feedback {
            font-size: 1.2em;
            font-weight: bold;
            min-height: 30px;
            transition: transform 0.2s ease;
        }

        .feedback-good { color: var(--success-color); transform: scale(1.1); }
        .feedback-bad { color: var(--error-color); transform: scale(0.9); }
        .feedback-early { color: var(--neutral-color); }

        #level-selection {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .level-btn {
            font-family: 'Assistant', sans-serif;
            font-size: 1em;
            font-weight: bold;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .level-btn:hover {
            background-color: #216279;
            transform: translateY(-2px);
        }
        
        .level-btn:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        #alpha-tab-container {
            width: 100%;
            margin: 20px auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            min-height: 150px; /* Ensures space is reserved for the score */
        }
    </style>
</head>
<body>
    <div class="game-container">
        <header>
            <h1>משחק קצב מחיאות כפיים</h1>
            <p class="instructions">לחצו על "אפשר" כדי להשתמש במיקרופון ובחרו תרגיל כדי להתחיל.</p>
        </header>

        <div class="game-info">
            <span>ניקוד: <span id="score">0</span></span>
            <span>רמה: <span id="level-name">-</span></span>
        </div>
        <p id="feedback">בהצלחה!</p>
        
        <div id="level-selection">
            <!-- Level buttons will be generated by JavaScript -->
        </div>

        <!-- Container for the AlphaTab renderer -->
        <div id="alpha-tab-container"></div>
    </div>

    <!-- AlphaTab Library -->
    <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@latest/dist/alphaTab.js"></script>
    
    <script>
    // --- 1. זיהוי מחיאות כפיים ---
    class ClapDetector {
        constructor(threshold = 150, debounceTime = 100) {
            this.threshold = threshold; // רגישות הזיהוי (ערך גבוה יותר = פחות רגיש)
            this.debounceTime = debounceTime; // זמן מינימלי בין מחיאות למניעת זיהוי כפול
            this.lastClapTime = 0;
            this.audioContext = null;
            this.onClap = () => {}; // Callback שיופעל בזיהוי מחיאה
            this.isListening = false;
        }

        async start() {
            if (this.isListening) return;

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("הדפדפן שלך לא תומך בגישה למיקרופון.");
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = this.audioContext.createMediaStreamSource(stream);
                const analyser = this.audioContext.createAnalyser();
                analyser.fftSize = 512;
                analyser.minDecibels = -90;
                analyser.maxDecibels = -10;
                analyser.smoothingTimeConstant = 0.85;

                source.connect(analyser);

                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                const detect = () => {
                    if (!this.isListening) return; // Stop the loop if listening is turned off
                    
                    analyser.getByteFrequencyData(dataArray);
                    let sum = dataArray.reduce((a, b) => a + b, 0);
                    let average = sum / dataArray.length;

                    // זיהוי "פיק" חד בעוצמת הקול
                    if (average > this.threshold) {
                        const now = Date.now();
                        if (now - this.lastClapTime > this.debounceTime) {
                            this.lastClapTime = now;
                            if (this.onClap) {
                                this.onClap();
                            }
                        }
                    }
                    requestAnimationFrame(detect);
                };
                
                this.isListening = true;
                detect();
            } catch (err) {
                console.error("שגיאה בגישה למיקרופון:", err);
                alert("שגיאה בגישה למיקרופון. אנא אשר את הגישה בדפדפן.");
            }
        }

        stop() {
            this.isListening = false;
            if (this.audioContext && this.audioContext.state !== 'closed') {
                this.audioContext.close();
            }
        }
    }

    // --- 2. הגדרת הרמות ---
    const levels = [
        {
            name: "רבעים",
            bpm: 80,
            alphaTex: `\\clef percussion \\ts 4 4 \\rhythm c4 c4 c4 c4 | c4 c4 c4 c4`
        },
        {
            name: "שמיניות",
            bpm: 90,
            alphaTex: `\\clef percussion \\ts 4 4 \\rhythm c8 c8 c8 c8 c8 c8 c8 c8 | c4 c8 c8 c4 c8 c8`
        },
        {
            name: "סינקופות",
            bpm: 100,
            alphaTex: `\\clef percussion \\ts 4 4 \\rhythm c8 c8 c4 c8 c8. c16 | c4. c8 r8 c8 c8 c8`
        },
        {
            name: "אתגר",
            bpm: 110,
            alphaTex: `\\clef percussion \\ts 4 4 \\rhythm c16 c16 c16 c16 c8 c8 c4 | c4 r8 c8 c4. | c8 r8 c8 r8 c8 c8 c8 c8 | c4. c8 c4 r4`
        }
    ];

    // --- 3. ליבת המשחק ---
    class RhythmGame {
        constructor(container) {
            this.api = new alphaTab.AlphaTabApi(container, {
                player: {
                    enablePlayer: true,
                    soundFont: "https://cdn.jsdelivr.net/npm/@coderline/alphatab@latest/dist/soundfonts/sg_gm_plus.sf2",
                    scrollElement: container,
                }
            });

            this.clapDetector = new ClapDetector();
            this.clapDetector.onClap = this.handleClap.bind(this);

            this.score = 0;
            this.notesInLevel = [];
            this.upcomingBeat = null;
            this.clappedForCurrentBeat = false;
            this.isGameActive = false;

            this.ui = {
                score: document.getElementById('score'),
                levelName: document.getElementById('level-name'),
                feedback: document.getElementById('feedback'),
                levelSelection: document.getElementById('level-selection')
            };
            
            this.setupUI();
            this.setupAlphaTabEvents();
        }

        setupUI() {
            levels.forEach((level, index) => {
                const button = document.createElement('button');
                button.innerText = level.name;
                button.className = 'level-btn';
                button.onclick = () => this.startLevel(index);
                this.ui.levelSelection.appendChild(button);
            });
        }
        
        setButtonsDisabled(disabled) {
            this.ui.levelSelection.querySelectorAll('button').forEach(btn => {
                btn.disabled = disabled;
            });
        }

        setupAlphaTabEvents() {
            // אירוע שמופעל בכל פעימה (beat)
            // תיקון: האירועים נמצאים על אובייקט ה-player של ה-API
            this.api.player.beatTicked.on(beat => {
                if (!this.isGameActive) return;
                
                // הערכת הפעימה הקודמת
                this.evaluatePreviousBeat();
                
                // הכנה לפעימה הנוכחית
                this.upcomingBeat = beat;
                this.clappedForCurrentBeat = false;
            });
            
            // אירוע שמופעל בסיום הנגינה
            this.api.player.playerStateChanged.on(e => {
                if (e.state === 0 && this.isGameActive) { // Stopped
                    this.evaluatePreviousBeat(); // בדוק את הפעימה האחרונה
                    this.isGameActive = false;
                    this.setButtonsDisabled(false);
                    this.showFeedback("כל הכבוד! נסה תרגיל אחר.", 'good');
                }
            });
        }

        async startLevel(levelIndex) {
            if (this.isGameActive) return;

            const levelData = levels[levelIndex];
            this.isGameActive = true;
            this.setButtonsDisabled(true);

            this.ui.levelName.innerText = levelData.name;
            this.score = 0;
            this.ui.score.innerText = this.score;
            this.showFeedback("התכונן...", 'neutral');

            try {
                // טוען את התווים
                await this.api.tex(levelData.alphaTex, {
                    settings: { player: { defaultTempo: levelData.bpm } }
                });
                
                // רק אם טעינת התווים הצליחה, נמשיך
                this.prepareNoteList();
                await this.clapDetector.start();

                setTimeout(() => {
                    this.api.play();
                    this.showFeedback("בהצלחה!", 'neutral');
                }, 2000); // השהייה קצרה להתארגנות

            } catch (error) {
                console.error("שגיאה בטעינת הרמה:", error);
                this.showFeedback("שגיאה בטעינה, נסה שוב", 'bad');
                this.isGameActive = false;
                this.setButtonsDisabled(false);
            }
        }
        
        prepareNoteList() {
            this.notesInLevel = [];
            // תיקון: בדיקה שאובייקט ה-score קיים לפני הגישה אליו
            if (!this.api.score) return;
            const track = this.api.score.tracks[0];
            track.staves.forEach(stave => {
                stave.voices.forEach(voice => {
                    voice.beats.forEach(beat => {
                        const hasNote = beat.notes.length > 0 && !beat.isRest;
                        this.notesInLevel.push({ beat, hasNote, evaluated: false });
                    });
                });
            });
        }

        handleClap() {
            if (!this.isGameActive || this.clappedForCurrentBeat) return;
            this.clappedForCurrentBeat = true;
        }

        evaluatePreviousBeat() {
            if (!this.upcomingBeat) return;

            const beatIndex = this.upcomingBeat.index - 1;
            if (beatIndex < 0 || beatIndex >= this.notesInLevel.length) return;

            const beatInfo = this.notesInLevel[beatIndex];
            if (beatInfo.evaluated) return; // מונע הערכה כפולה

            const shouldHaveClapped = beatInfo.hasNote;
            const didClap = this.clappedForCurrentBeat;

            if (shouldHaveClapped && didClap) {
                this.showFeedback("מעולה!", 'good');
                this.score += 10;
            } else if (shouldHaveClapped && !didClap) {
                this.showFeedback("פספוס...", 'bad');
            } else if (!shouldHaveClapped && didClap) {
                this.showFeedback("מוקדם מדי!", 'early');
                this.score -= 5;
            }

            beatInfo.evaluated = true;
            this.ui.score.innerText = this.score;
        }
        
        showFeedback(message, type) {
            this.ui.feedback.innerText = message;
            this.ui.feedback.className = ''; // Reset classes
            
            // Add a slight delay for the class to be applied correctly
            setTimeout(() => {
                if (type === 'good') this.ui.feedback.classList.add('feedback-good');
                else if (type === 'bad') this.ui.feedback.classList.add('feedback-bad');
                else if (type === 'early') this.ui.feedback.classList.add('feedback-early');
            }, 10);
        }
    }

    // --- 4. אתחול המשחק ---
    window.addEventListener('load', () => {
        const game = new RhythmGame(document.getElementById('alpha-tab-container'));
    });
    </script>
</body>
</html>
